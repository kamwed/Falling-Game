<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rivalries - Sky Fall</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #60a5fa, #2563eb);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tagline {
            font-size: 18px;
            opacity: 0.9;
        }

        .back-button {
            display: inline-block;
            padding: 12px 30px;
            background: #22c55e;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s;
            margin-bottom: 30px;
            border: none;
            cursor: pointer;
        }

        .back-button:hover {
            background: #16a34a;
            transform: scale(1.05);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: #1f2937;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subtitle {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* State containers */
        .state-container {
            display: none;
        }

        .state-container.active {
            display: block;
        }

        /* Not logged in state */
        .not-logged-in {
            text-align: center;
            padding: 60px 20px;
        }

        .not-logged-in h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .not-logged-in p {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* Not joined state */
        .not-joined {
            padding: 40px 20px;
        }

        .not-joined h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .not-joined p {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Join form */
        .join-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 16px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-hint {
            font-size: 14px;
            color: #6b7280;
            margin-top: 6px;
        }

        /* Joined state */
        .joined {
            padding: 40px 20px;
        }

        .joined h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .rivalry-info {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .rivalry-info .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .rivalry-info .affiliation {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 10px;
        }

        .rivalry-info .placeholder {
            font-size: 18px;
            color: #6b7280;
        }

        /* TopSeat highlighting */
        .topseat-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .topseat-highlight {
            background: linear-gradient(to right, #fef3c7, #fef3c7) !important;
            border: 2px solid #fbbf24 !important;
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .autocomplete-input.has-selection {
            border-color: #22c55e;
        }

        .autocomplete-input.error {
            border-color: #ef4444;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #2563eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.1s;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover {
            background: #f3f4f6;
        }

        .autocomplete-suggestion.selected {
            background: #dbeafe;
        }

        .suggestion-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .suggestion-location {
            font-size: 13px;
            color: #6b7280;
        }

        .no-suggestions {
            padding: 12px;
            color: #6b7280;
            font-style: italic;
        }

        .autocomplete-loading {
            padding: 12px;
            color: #6b7280;
            text-align: center;
        }

        /* Buttons */
        .primary-button {
            width: 100%;
            padding: 14px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .primary-button:hover:not(:disabled) {
            background: #1e40af;
            transform: scale(1.02);
        }

        .primary-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .secondary-button {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .secondary-button:hover {
            background: #4b5563;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #86efac;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #fca5a5;
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 36px;
            }

            h1 {
                font-size: 28px;
            }

            .content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">&#127918; Sky Fall</div>
            <div class="tagline">Challenge your school and frat to rivalry battles!</div>
        </div>

        <a href="index.html" class="back-button">&larr; Back to Game</a>

        <div class="content">
            <h1>
                <span>&#9876;</span>
                Rivalries
            </h1>
            <p class="subtitle">Compete with other schools and fraternities!</p>

            <!-- State 1: Not Logged In -->
            <div id="notLoggedInState" class="state-container">
                <div class="not-logged-in">
                    <h2>Log in to participate in rivalries</h2>
                    <p>Join the competition and represent your school and fraternity!</p>
                    <button class="primary-button" onclick="goToLogin()">Log In</button>
                </div>
            </div>

            <!-- State 2: Not Joined -->
            <div id="notJoinedState" class="state-container">
                <div class="not-joined">
                    <h2>Join rivalries to represent your school and frat</h2>
                    <p>Select your school and fraternity to start competing in rivalries!</p>

                    <div id="messageArea" class="message"></div>

                    <form id="joinForm" class="join-form">
                        <div class="form-group">
                            <label for="school">School / University</label>
                            <div class="autocomplete-container">
                                <input 
                                    type="text"
                                    id="school" 
                                    name="school"
                                    class="autocomplete-input"
                                    placeholder="Start typing your school name..."
                                    autocomplete="off"
                                    required
                                >
                                <div id="schoolSuggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <div class="form-hint">Type to search for your school or university</div>
                        </div>

                        <div class="form-group">
                            <label for="frat">Fraternity / Sorority</label>
                            <div class="autocomplete-container">
                                <input 
                                    type="text"
                                    id="frat" 
                                    name="frat"
                                    class="autocomplete-input"
                                    placeholder="Start typing your organization name..."
                                    autocomplete="off"
                                    required
                                >
                                <div id="fratSuggestions" class="autocomplete-suggestions"></div>
                            </div>
                            <div class="form-hint">Type to search for your fraternity or sorority</div>
                        </div>

                        <button type="submit" class="primary-button" id="joinButton">Join Rivalries</button>
                    </form>
                </div>
            </div>

            <!-- State 3: Joined -->
            <div id="joinedState" class="state-container">
                <div class="joined">
                    <!-- View Mode -->
                    <div id="viewMode">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2 style="margin: 0;">Representing <span id="displayFrat"></span> at <span id="displaySchool"></span></h2>
                            <button 
                                onclick="enterEditMode()" 
                                style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;"
                                onmouseover="this.style.background='#4b5563'" 
                                onmouseout="this.style.background='#6b7280'"
                            >
                                Edit
                            </button>
                        </div>

                        <!-- Individual Rank Section -->
                        <div class="rivalry-info">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#128100; Your Individual Rank
                            </div>
                            <div id="individualRankDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <!-- Frat Rank Section -->
                        <div class="rivalry-info">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#9876; Your Frat's Rank
                            </div>
                            <div id="fratRankDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <!-- TopSeat Section -->
                        <div class="rivalry-info" id="topSeatSection">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#127942; TopSeat
                            </div>
                            <div id="topSeatDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <button class="secondary-button" onclick="leaveRivalries()" style="display: block; margin: 20px auto 0;">
                            Leave Rivalries
                        </button>
                    </div>

                    <!-- Edit Mode -->
                    <div id="editMode" style="display: none;">
                        <h2 style="margin-bottom: 10px;">Edit Your Affiliation</h2>
                        <p style="color: #6b7280; margin-bottom: 30px;">Update your school and fraternity/sorority</p>

                        <div id="editMessageArea" class="message" style="margin-bottom: 20px;"></div>

                        <form id="editForm" class="join-form">
                            <div class="form-group">
                                <label for="editSchool">School / University</label>
                                <div class="autocomplete-container">
                                    <input 
                                        type="text"
                                        id="editSchool" 
                                        name="editSchool"
                                        class="autocomplete-input"
                                        placeholder="Start typing your school name..."
                                        autocomplete="off"
                                        required
                                    >
                                    <div id="editSchoolSuggestions" class="autocomplete-suggestions"></div>
                                </div>
                                <div class="form-hint">Type to search for your school or university</div>
                            </div>

                            <div class="form-group">
                                <label for="editFrat">Fraternity / Sorority</label>
                                <div class="autocomplete-container">
                                    <input 
                                        type="text"
                                        id="editFrat" 
                                        name="editFrat"
                                        class="autocomplete-input"
                                        placeholder="Start typing your organization name..."
                                        autocomplete="off"
                                        required
                                    >
                                    <div id="editFratSuggestions" class="autocomplete-suggestions"></div>
                                </div>
                                <div class="form-hint">Type to search for your fraternity or sorority</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="primary-button" id="saveButton" style="flex: 1;">
                                    Save Changes
                                </button>
                                <button type="button" class="secondary-button" onclick="cancelEdit()" style="flex: 1;">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <a href="index.html" class="back-button">Back to Game &#127918;</a>
            </div>
        </div>
    </div>

    <script type="module">
        // =============================================================================
        // EMBEDDED SCHOOLS DATA (to avoid loading issues)
        // =============================================================================
        
        const SCHOOLS_DATA = [
            // Big Ten Conference
            { id: "umich", name: "University of Michigan", city: "Ann Arbor", state: "MI" },
            { id: "msu", name: "Michigan State University", city: "East Lansing", state: "MI" },
            { id: "osu", name: "Ohio State University", city: "Columbus", state: "OH" },
            { id: "psu", name: "Penn State University", city: "University Park", state: "PA" },
            { id: "wisc", name: "University of Wisconsin", city: "Madison", state: "WI" },
            { id: "indiana", name: "Indiana University", city: "Bloomington", state: "IN" },
            { id: "purdue", name: "Purdue University", city: "West Lafayette", state: "IN" },
            { id: "uiuc", name: "University of Illinois", city: "Urbana-Champaign", state: "IL" },
            { id: "northwestern", name: "Northwestern University", city: "Evanston", state: "IL" },
            { id: "iowa", name: "University of Iowa", city: "Iowa City", state: "IA" },
            { id: "minn", name: "University of Minnesota", city: "Minneapolis", state: "MN" },
            { id: "nebraska", name: "University of Nebraska", city: "Lincoln", state: "NE" },
            { id: "rutgers", name: "Rutgers University", city: "New Brunswick", state: "NJ" },
            { id: "umd", name: "University of Maryland", city: "College Park", state: "MD" },

            // Ivy League
            { id: "harvard", name: "Harvard University", city: "Cambridge", state: "MA" },
            { id: "yale", name: "Yale University", city: "New Haven", state: "CT" },
            { id: "princeton", name: "Princeton University", city: "Princeton", state: "NJ" },
            { id: "columbia", name: "Columbia University", city: "New York", state: "NY" },
            { id: "upenn", name: "University of Pennsylvania", city: "Philadelphia", state: "PA" },
            { id: "brown", name: "Brown University", city: "Providence", state: "RI" },
            { id: "dartmouth", name: "Dartmouth College", city: "Hanover", state: "NH" },
            { id: "cornell", name: "Cornell University", city: "Ithaca", state: "NY" },

            // SEC
            { id: "alabama", name: "University of Alabama", city: "Tuscaloosa", state: "AL" },
            { id: "auburn", name: "Auburn University", city: "Auburn", state: "AL" },
            { id: "florida", name: "University of Florida", city: "Gainesville", state: "FL" },
            { id: "uga", name: "University of Georgia", city: "Athens", state: "GA" },
            { id: "kentucky", name: "University of Kentucky", city: "Lexington", state: "KY" },
            { id: "lsu", name: "Louisiana State University", city: "Baton Rouge", state: "LA" },
            { id: "ole-miss", name: "University of Mississippi", city: "Oxford", state: "MS" },
            { id: "msu-sec", name: "Mississippi State University", city: "Starkville", state: "MS" },
            { id: "mizzou", name: "University of Missouri", city: "Columbia", state: "MO" },
            { id: "sc", name: "University of South Carolina", city: "Columbia", state: "SC" },
            { id: "tennessee", name: "University of Tennessee", city: "Knoxville", state: "TN" },
            { id: "vanderbilt", name: "Vanderbilt University", city: "Nashville", state: "TN" },
            { id: "texas-am", name: "Texas A&M University", city: "College Station", state: "TX" },
            { id: "arkansas", name: "University of Arkansas", city: "Fayetteville", state: "AR" },

            // ACC
            { id: "duke", name: "Duke University", city: "Durham", state: "NC" },
            { id: "unc", name: "University of North Carolina", city: "Chapel Hill", state: "NC" },
            { id: "nc-state", name: "North Carolina State University", city: "Raleigh", state: "NC" },
            { id: "wake-forest", name: "Wake Forest University", city: "Winston-Salem", state: "NC" },
            { id: "clemson", name: "Clemson University", city: "Clemson", state: "SC" },
            { id: "fsu", name: "Florida State University", city: "Tallahassee", state: "FL" },
            { id: "miami", name: "University of Miami", city: "Coral Gables", state: "FL" },
            { id: "gt", name: "Georgia Tech", city: "Atlanta", state: "GA" },
            { id: "uva", name: "University of Virginia", city: "Charlottesville", state: "VA" },
            { id: "vt", name: "Virginia Tech", city: "Blacksburg", state: "VA" },
            { id: "pitt", name: "University of Pittsburgh", city: "Pittsburgh", state: "PA" },
            { id: "bc", name: "Boston College", city: "Chestnut Hill", state: "MA" },
            { id: "syracuse", name: "Syracuse University", city: "Syracuse", state: "NY" },
            { id: "louisville", name: "University of Louisville", city: "Louisville", state: "KY" },

            // Pac-12 / West Coast
            { id: "stanford", name: "Stanford University", city: "Stanford", state: "CA" },
            { id: "berkeley", name: "UC Berkeley", city: "Berkeley", state: "CA" },
            { id: "ucla", name: "UCLA", city: "Los Angeles", state: "CA" },
            { id: "usc", name: "University of Southern California", city: "Los Angeles", state: "CA" },
            { id: "ucsd", name: "UC San Diego", city: "San Diego", state: "CA" },
            { id: "uci", name: "UC Irvine", city: "Irvine", state: "CA" },
            { id: "ucsb", name: "UC Santa Barbara", city: "Santa Barbara", state: "CA" },
            { id: "ucd", name: "UC Davis", city: "Davis", state: "CA" },
            { id: "ucr", name: "UC Riverside", city: "Riverside", state: "CA" },
            { id: "ucsc", name: "UC Santa Cruz", city: "Santa Cruz", state: "CA" },
            { id: "caltech", name: "California Institute of Technology", city: "Pasadena", state: "CA" },
            { id: "oregon", name: "University of Oregon", city: "Eugene", state: "OR" },
            { id: "oregon-state", name: "Oregon State University", city: "Corvallis", state: "OR" },
            { id: "washington", name: "University of Washington", city: "Seattle", state: "WA" },
            { id: "wsu", name: "Washington State University", city: "Pullman", state: "WA" },
            { id: "arizona", name: "University of Arizona", city: "Tucson", state: "AZ" },
            { id: "asu", name: "Arizona State University", city: "Tempe", state: "AZ" },
            { id: "colorado", name: "University of Colorado", city: "Boulder", state: "CO" },
            { id: "utah", name: "University of Utah", city: "Salt Lake City", state: "UT" },

            // Big 12
            { id: "texas", name: "University of Texas", city: "Austin", state: "TX" },
            { id: "oklahoma", name: "University of Oklahoma", city: "Norman", state: "OK" },
            { id: "osu-bigxii", name: "Oklahoma State University", city: "Stillwater", state: "OK" },
            { id: "tcu", name: "Texas Christian University", city: "Fort Worth", state: "TX" },
            { id: "baylor", name: "Baylor University", city: "Waco", state: "TX" },
            { id: "texas-tech", name: "Texas Tech University", city: "Lubbock", state: "TX" },
            { id: "kansas", name: "University of Kansas", city: "Lawrence", state: "KS" },
            { id: "ksu", name: "Kansas State University", city: "Manhattan", state: "KS" },
            { id: "iowa-state", name: "Iowa State University", city: "Ames", state: "IA" },
            { id: "wvu", name: "West Virginia University", city: "Morgantown", state: "WV" },

            // Other Major Universities
            { id: "mit", name: "Massachusetts Institute of Technology", city: "Cambridge", state: "MA" },
            { id: "chicago", name: "University of Chicago", city: "Chicago", state: "IL" },
            { id: "nyu", name: "New York University", city: "New York", state: "NY" },
            { id: "bu", name: "Boston University", city: "Boston", state: "MA" },
            { id: "northeastern", name: "Northeastern University", city: "Boston", state: "MA" },
            { id: "carnegie-mellon", name: "Carnegie Mellon University", city: "Pittsburgh", state: "PA" },
            { id: "notre-dame", name: "University of Notre Dame", city: "Notre Dame", state: "IN" },
            { id: "rice", name: "Rice University", city: "Houston", state: "TX" },
            { id: "emory", name: "Emory University", city: "Atlanta", state: "GA" },
            { id: "wash-u", name: "Washington University in St. Louis", city: "St. Louis", state: "MO" },
            { id: "georgetown", name: "Georgetown University", city: "Washington", state: "DC" },
            { id: "tufts", name: "Tufts University", city: "Medford", state: "MA" },
            { id: "case-western", name: "Case Western Reserve University", city: "Cleveland", state: "OH" },
            { id: "tulane", name: "Tulane University", city: "New Orleans", state: "LA" },
            { id: "ucf", name: "University of Central Florida", city: "Orlando", state: "FL" },
            { id: "usf", name: "University of South Florida", city: "Tampa", state: "FL" },
            { id: "fiu", name: "Florida International University", city: "Miami", state: "FL" },
            { id: "uh", name: "University of Houston", city: "Houston", state: "TX" },
            { id: "smu", name: "Southern Methodist University", city: "Dallas", state: "TX" },
        ];

        // Schools data functions
        function searchSchools(query, maxResults = 10) {
            if (!query || query.trim().length < 2) {
                return [];
            }

            const searchTerm = query.toLowerCase().trim();
            
            const matches = SCHOOLS_DATA.filter(school => {
                const nameMatch = school.name.toLowerCase().includes(searchTerm);
                const cityMatch = school.city.toLowerCase().includes(searchTerm);
                const stateMatch = school.state.toLowerCase().includes(searchTerm);
                return nameMatch || cityMatch || stateMatch;
            });

            matches.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                
                if (aName === searchTerm) return -1;
                if (bName === searchTerm) return 1;
                
                const aStarts = aName.startsWith(searchTerm);
                const bStarts = bName.startsWith(searchTerm);
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                
                return aName.localeCompare(bName);
            });

            return matches.slice(0, maxResults);
        }

        function getSchoolByName(name) {
            return SCHOOLS_DATA.find(school => school.name === name) || null;
        }

        // Expose to window for compatibility
        window.SchoolsData = {
            searchSchools,
            getSchoolByName,
            SCHOOLS_COUNT: SCHOOLS_DATA.length
        };

        console.log('Schools data loaded:', window.SchoolsData.SCHOOLS_COUNT, 'schools');

        // =============================================================================
        // FRATERNITIES & SORORITIES DATA
        // =============================================================================
        
        const FRATS_DATA = [
            // National Fraternities (IFC)
            { id: "alpha-chi-rho", name: "Alpha Chi Rho", type: "fraternity" },
            { id: "alpha-epsilon-pi", name: "Alpha Epsilon Pi", type: "fraternity" },
            { id: "alpha-gamma-rho", name: "Alpha Gamma Rho", type: "fraternity" },
            { id: "alpha-phi-alpha", name: "Alpha Phi Alpha", type: "fraternity" },
            { id: "alpha-sigma-phi", name: "Alpha Sigma Phi", type: "fraternity" },
            { id: "alpha-tau-omega", name: "Alpha Tau Omega", type: "fraternity" },
            { id: "beta-theta-pi", name: "Beta Theta Pi", type: "fraternity" },
            { id: "chi-phi", name: "Chi Phi", type: "fraternity" },
            { id: "chi-psi", name: "Chi Psi", type: "fraternity" },
            { id: "delta-chi", name: "Delta Chi", type: "fraternity" },
            { id: "delta-kappa-epsilon", name: "Delta Kappa Epsilon", type: "fraternity" },
            { id: "delta-sigma-phi", name: "Delta Sigma Phi", type: "fraternity" },
            { id: "delta-tau-delta", name: "Delta Tau Delta", type: "fraternity" },
            { id: "delta-upsilon", name: "Delta Upsilon", type: "fraternity" },
            { id: "farmhouse", name: "FarmHouse", type: "fraternity" },
            { id: "kappa-alpha", name: "Kappa Alpha Order", type: "fraternity" },
            { id: "kappa-alpha-psi", name: "Kappa Alpha Psi", type: "fraternity" },
            { id: "kappa-sigma", name: "Kappa Sigma", type: "fraternity" },
            { id: "lambda-chi-alpha", name: "Lambda Chi Alpha", type: "fraternity" },
            { id: "omega-psi-phi", name: "Omega Psi Phi", type: "fraternity" },
            { id: "phi-delta-theta", name: "Phi Delta Theta", type: "fraternity" },
            { id: "phi-gamma-delta", name: "Phi Gamma Delta (FIJI)", type: "fraternity" },
            { id: "phi-kappa-psi", name: "Phi Kappa Psi", type: "fraternity" },
            { id: "phi-kappa-sigma", name: "Phi Kappa Sigma", type: "fraternity" },
            { id: "phi-kappa-tau", name: "Phi Kappa Tau", type: "fraternity" },
            { id: "phi-sigma-kappa", name: "Phi Sigma Kappa", type: "fraternity" },
            { id: "phi-beta-sigma", name: "Phi Beta Sigma", type: "fraternity" },
            { id: "pi-kappa-alpha", name: "Pi Kappa Alpha", type: "fraternity" },
            { id: "pi-kappa-phi", name: "Pi Kappa Phi", type: "fraternity" },
            { id: "pi-lambda-phi", name: "Pi Lambda Phi", type: "fraternity" },
            { id: "psi-upsilon", name: "Psi Upsilon", type: "fraternity" },
            { id: "sigma-alpha-epsilon", name: "Sigma Alpha Epsilon", type: "fraternity" },
            { id: "sigma-chi", name: "Sigma Chi", type: "fraternity" },
            { id: "sigma-nu", name: "Sigma Nu", type: "fraternity" },
            { id: "sigma-phi-epsilon", name: "Sigma Phi Epsilon", type: "fraternity" },
            { id: "sigma-pi", name: "Sigma Pi", type: "fraternity" },
            { id: "sigma-tau-gamma", name: "Sigma Tau Gamma", type: "fraternity" },
            { id: "tau-kappa-epsilon", name: "Tau Kappa Epsilon", type: "fraternity" },
            { id: "theta-chi", name: "Theta Chi", type: "fraternity" },
            { id: "theta-delta-chi", name: "Theta Delta Chi", type: "fraternity" },
            { id: "theta-xi", name: "Theta Xi", type: "fraternity" },
            { id: "triangle", name: "Triangle", type: "fraternity" },
            { id: "zeta-beta-tau", name: "Zeta Beta Tau", type: "fraternity" },
            { id: "zeta-psi", name: "Zeta Psi", type: "fraternity" },

            // National Sororities (Panhellenic)
            { id: "alpha-chi-omega", name: "Alpha Chi Omega", type: "sorority" },
            { id: "alpha-delta-pi", name: "Alpha Delta Pi", type: "sorority" },
            { id: "alpha-epsilon-phi", name: "Alpha Epsilon Phi", type: "sorority" },
            { id: "alpha-gamma-delta", name: "Alpha Gamma Delta", type: "sorority" },
            { id: "alpha-kappa-alpha", name: "Alpha Kappa Alpha", type: "sorority" },
            { id: "alpha-omicron-pi", name: "Alpha Omicron Pi", type: "sorority" },
            { id: "alpha-phi", name: "Alpha Phi", type: "sorority" },
            { id: "alpha-sigma-alpha", name: "Alpha Sigma Alpha", type: "sorority" },
            { id: "alpha-sigma-tau", name: "Alpha Sigma Tau", type: "sorority" },
            { id: "alpha-xi-delta", name: "Alpha Xi Delta", type: "sorority" },
            { id: "chi-omega", name: "Chi Omega", type: "sorority" },
            { id: "delta-delta-delta", name: "Delta Delta Delta (Tri Delta)", type: "sorority" },
            { id: "delta-gamma", name: "Delta Gamma", type: "sorority" },
            { id: "delta-phi-epsilon", name: "Delta Phi Epsilon", type: "sorority" },
            { id: "delta-sigma-theta", name: "Delta Sigma Theta", type: "sorority" },
            { id: "delta-zeta", name: "Delta Zeta", type: "sorority" },
            { id: "gamma-phi-beta", name: "Gamma Phi Beta", type: "sorority" },
            { id: "kappa-alpha-theta", name: "Kappa Alpha Theta", type: "sorority" },
            { id: "kappa-delta", name: "Kappa Delta", type: "sorority" },
            { id: "kappa-kappa-gamma", name: "Kappa Kappa Gamma", type: "sorority" },
            { id: "phi-mu", name: "Phi Mu", type: "sorority" },
            { id: "phi-sigma-sigma", name: "Phi Sigma Sigma", type: "sorority" },
            { id: "pi-beta-phi", name: "Pi Beta Phi", type: "sorority" },
            { id: "sigma-delta-tau", name: "Sigma Delta Tau", type: "sorority" },
            { id: "sigma-gamma-rho", name: "Sigma Gamma Rho", type: "sorority" },
            { id: "sigma-kappa", name: "Sigma Kappa", type: "sorority" },
            { id: "sigma-sigma-sigma", name: "Sigma Sigma Sigma (Tri Sigma)", type: "sorority" },
            { id: "theta-phi-alpha", name: "Theta Phi Alpha", type: "sorority" },
            { id: "zeta-phi-beta", name: "Zeta Phi Beta", type: "sorority" },
            { id: "zeta-tau-alpha", name: "Zeta Tau Alpha", type: "sorority" },

            // Cultural & Multicultural
            { id: "lambda-theta-alpha", name: "Lambda Theta Alpha (Latina)", type: "sorority" },
            { id: "lambda-theta-nu", name: "Lambda Theta Nu (Latina)", type: "sorority" },
            { id: "sigma-lambda-beta", name: "Sigma Lambda Beta (Latino)", type: "fraternity" },
            { id: "lambda-theta-phi", name: "Lambda Theta Phi (Latino)", type: "fraternity" },
            { id: "lambda-upsilon-lambda", name: "Lambda Upsilon Lambda (Latino)", type: "fraternity" },
            { id: "sigma-lambda-gamma", name: "Sigma Lambda Gamma (Multicultural)", type: "sorority" },
            { id: "alpha-kappa-delta-phi", name: "alpha Kappa Delta Phi (Asian)", type: "sorority" },
            { id: "sigma-psi-zeta", name: "Sigma Psi Zeta (Asian)", type: "sorority" },
            { id: "lambda-phi-epsilon", name: "Lambda Phi Epsilon (Asian)", type: "fraternity" },
            { id: "alpha-epsilon-omega", name: "Alpha Epsilon Omega (Christian)", type: "fraternity" },
            { id: "beta-upsilon-chi", name: "Beta Upsilon Chi (Christian)", type: "fraternity" },

            // Professional & Service
            { id: "alpha-phi-omega", name: "Alpha Phi Omega (Service)", type: "coed" },
            { id: "phi-sigma-pi", name: "Phi Sigma Pi (Honor)", type: "coed" },
            { id: "alpha-kappa-psi", name: "Alpha Kappa Psi (Business)", type: "coed" },
            { id: "delta-sigma-pi", name: "Delta Sigma Pi (Business)", type: "coed" },
        ];

        // Fraternities data functions
        function searchFrats(query, maxResults = 10) {
            if (!query || query.trim().length < 2) {
                return [];
            }

            const searchTerm = query.toLowerCase().trim();
            
            const matches = FRATS_DATA.filter(frat => {
                const nameMatch = frat.name.toLowerCase().includes(searchTerm);
                const typeMatch = frat.type.toLowerCase().includes(searchTerm);
                return nameMatch || typeMatch;
            });

            matches.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                
                if (aName === searchTerm) return -1;
                if (bName === searchTerm) return 1;
                
                const aStarts = aName.startsWith(searchTerm);
                const bStarts = bName.startsWith(searchTerm);
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                
                return aName.localeCompare(bName);
            });

            return matches.slice(0, maxResults);
        }

        function getFratByName(name) {
            return FRATS_DATA.find(frat => frat.name === name) || null;
        }

        // Expose to window
        window.FratsData = {
            searchFrats,
            getFratByName,
            FRATS_COUNT: FRATS_DATA.length
        };

        console.log('Fraternities data loaded:', window.FratsData.FRATS_COUNT, 'organizations');

        // =============================================================================
        // END FRATERNITIES DATA
        // =============================================================================
        // =============================================================================
        // RIVALRY STATS AGGREGATION FUNCTIONS
        // =============================================================================
        
        /**
         * Get individual rank for a user within their school
         */
        function getIndividualRankForUser(userId, schoolId, allUsers) {
            const schoolUsers = allUsers.filter(user => 
                user.school === schoolId && 
                user.score !== undefined && 
                user.score !== null
            );

            if (schoolUsers.length === 0) {
                return { rank: null, totalUsers: 0 };
            }

            const sortedUsers = schoolUsers.sort((a, b) => b.score - a.score);
            const userIndex = sortedUsers.findIndex(user => user.uid === userId);

            if (userIndex === -1) {
                return { rank: null, totalUsers: schoolUsers.length };
            }

            return {
                rank: userIndex + 1,
                totalUsers: schoolUsers.length
            };
        }

        /**
         * Get fraternity rank for a user's frat within their school
         */
        function getFratRankForUser(userId, allUsers) {
            const user = allUsers.find(u => u.uid === userId);

            if (!user || !user.school || !user.frat) {
                return { fratName: null, rank: null, totalFrats: 0, totalScore: 0, memberCount: 0 };
            }

            const schoolUsers = allUsers.filter(u => 
                u.school === user.school && 
                u.frat && 
                u.score !== undefined && 
                u.score !== null
            );

            if (schoolUsers.length === 0) {
                return { fratName: user.frat, rank: null, totalFrats: 0, totalScore: 0, memberCount: 0 };
            }

            const fratScores = {};
            
            schoolUsers.forEach(u => {
                if (!fratScores[u.frat]) {
                    fratScores[u.frat] = {
                        fratName: u.frat,
                        totalScore: 0,
                        memberCount: 0
                    };
                }
                fratScores[u.frat].totalScore += u.score;
                fratScores[u.frat].memberCount += 1;
            });

            const fratRankings = Object.values(fratScores).sort((a, b) => 
                b.totalScore - a.totalScore
            );

            const fratRank = fratRankings.findIndex(f => f.fratName === user.frat);

            if (fratRank === -1) {
                return { 
                    fratName: user.frat, 
                    rank: null, 
                    totalFrats: fratRankings.length, 
                    totalScore: 0,
                    memberCount: 0
                };
            }

            return {
                fratName: user.frat,
                rank: fratRank + 1,
                totalFrats: fratRankings.length,
                totalScore: fratRankings[fratRank].totalScore,
                memberCount: fratRankings[fratRank].memberCount
            };
        }

        /**
         * Get the top-ranked fraternity at a specific school (TopSeat)
         */
        function getTopSeatFratForSchool(schoolId, allUsers) {
            const schoolUsers = allUsers.filter(u => 
                u.school === schoolId && 
                u.frat && 
                u.score !== undefined && 
                u.score !== null
            );

            if (schoolUsers.length === 0) {
                return null;
            }

            const fratScores = {};
            
            schoolUsers.forEach(u => {
                if (!fratScores[u.frat]) {
                    fratScores[u.frat] = {
                        fratName: u.frat,
                        totalScore: 0,
                        memberCount: 0
                    };
                }
                fratScores[u.frat].totalScore += u.score;
                fratScores[u.frat].memberCount += 1;
            });

            const fratRankings = Object.values(fratScores).sort((a, b) => 
                b.totalScore - a.totalScore
            );

            return fratRankings.length > 0 ? fratRankings[0] : null;
        }

        // =============================================================================
        // FIREBASE AND APP INITIALIZATION
        // =============================================================================

        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, Timestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        
        // Import event logging system
        import { initEventLogger, logJoinedRivalries } from './event-logger.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBic7ZeUQDgPZqORn0t6-wUCGHfEPASE10",
            authDomain: "topseat-d1d5d.firebaseapp.com",
            projectId: "topseat-d1d5d",
            storageBucket: "topseat-d1d5d.firebasestorage.app",
            messagingSenderId: "770306321288",
            appId: "1:770306321288:web:0e768acffc4d189672283d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Initialize event logger
        initEventLogger(db);

        // =============================================================================
        // HARDCODED RIVALRY OPTIONS
        // Edit these arrays to add more schools and fraternities/sororities
        // =============================================================================
        
        const SCHOOLS = [
            "University of Michigan",
            "Michigan State University",
            "Ohio State University",
            "Penn State University",
            "University of Wisconsin",
            "Indiana University",
            "Purdue University",
            "University of Illinois",
            "Northwestern University",
            "University of Iowa",
            "University of Minnesota",
            "University of Nebraska",
            "Rutgers University",
            "University of Maryland"
        ];

        const FRATS = [
            "Alpha",
            "Beta",
            "Gamma",
            "Delta",
            "Sigma Chi",
            "Phi Delta Theta",
            "Kappa Sigma",
            "Lambda Chi Alpha",
            "Pi Kappa Alpha",
            "Sigma Alpha Epsilon",
            "Tau Kappa Epsilon",
            "Sigma Nu",
            "Phi Kappa Psi",
            "Delta Tau Delta",
            "Theta Chi",
            "Kappa Alpha",
            "Alpha Tau Omega",
            "Phi Gamma Delta",
            "Beta Theta Pi",
            "Sigma Phi Epsilon"
        ];

        // =============================================================================

        let currentUser = null;
        let userData = null;
        let isEditMode = false; // Track if user is editing their school/frat

        // Autocomplete state
        let selectedSchool = null; // Stores { id, name, city, state }
        let selectedEditSchool = null; // For edit mode
        let selectedFrat = null; // Stores { id, name, type }
        let selectedEditFrat = null; // For edit mode
        let searchTimeout = null;

        // DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notLoggedInState = document.getElementById('notLoggedInState');
        const notJoinedState = document.getElementById('notJoinedState');
        const joinedState = document.getElementById('joinedState');
        const messageArea = document.getElementById('messageArea');
        const joinForm = document.getElementById('joinForm');
        const joinButton = document.getElementById('joinButton');

        // Show/hide loading
        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // Show message
        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            setTimeout(() => {
                messageArea.className = 'message';
            }, 5000);
        }

        // =============================================================================
        // AUTOCOMPLETE FUNCTIONALITY
        // =============================================================================

        /**
         * Initialize autocomplete for a school input
         * @param {string} inputId - ID of the input element
         * @param {string} suggestionsId - ID of the suggestions container
         * @param {function} onSelect - Callback when a school is selected
         */
        function initializeAutocomplete(inputId, suggestionsId, onSelect) {
            const input = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            let currentFocus = -1;

            if (!input || !suggestionsContainer) {
                console.error('Autocomplete elements not found:', inputId, suggestionsId);
                return;
            }

            // Handle input changes
            input.addEventListener('input', function() {
                const query = this.value;
                currentFocus = -1;

                // Clear timeout for debouncing
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Clear selection when typing
                if (inputId === 'school') {
                    selectedSchool = null;
                    input.classList.remove('has-selection');
                } else if (inputId === 'editSchool') {
                    selectedEditSchool = null;
                    input.classList.remove('has-selection');
                } else if (inputId === 'frat') {
                    selectedFrat = null;
                    input.classList.remove('has-selection');
                } else if (inputId === 'editFrat') {
                    selectedEditFrat = null;
                    input.classList.remove('has-selection');
                }

                // Hide suggestions if query is too short
                if (!query || query.length < 2) {
                    suggestionsContainer.classList.remove('active');
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                // Check which data to use based on inputId
                const isFratInput = inputId.includes('rat'); // 'frat' or 'editFrat'
                
                if (isFratInput) {
                    // Check if FratsData is available
                    if (!window.FratsData || !window.FratsData.searchFrats) {
                        console.error('FratsData not loaded!');
                        suggestionsContainer.innerHTML = '<div class="no-suggestions">Fraternities data not loaded. Please refresh the page.</div>';
                        suggestionsContainer.classList.add('active');
                        return;
                    }
                } else {
                    // Check if SchoolsData is available
                    if (!window.SchoolsData || !window.SchoolsData.searchSchools) {
                        console.error('SchoolsData not loaded!');
                        suggestionsContainer.innerHTML = '<div class="no-suggestions">School data not loaded. Please refresh the page.</div>';
                        suggestionsContainer.classList.add('active');
                        return;
                    }
                }

                // Debounce search (250ms delay)
                searchTimeout = setTimeout(() => {
                    const results = isFratInput 
                        ? window.FratsData.searchFrats(query, 10)
                        : window.SchoolsData.searchSchools(query, 10);
                    displaySuggestions(results, suggestionsContainer, input, onSelect, isFratInput);
                }, 250);
            });

            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const suggestions = suggestionsContainer.getElementsByClassName('autocomplete-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    addActive(suggestions, currentFocus);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    addActive(suggestions, currentFocus);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && suggestions[currentFocus]) {
                        suggestions[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestionsContainer.classList.remove('active');
                    suggestionsContainer.innerHTML = '';
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== input && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.classList.remove('active');
                }
            });

            function addActive(suggestions, index) {
                if (!suggestions || suggestions.length === 0) return;
                removeActive(suggestions);
                if (index >= suggestions.length) currentFocus = 0;
                if (index < 0) currentFocus = suggestions.length - 1;
                if (suggestions[currentFocus]) {
                    suggestions[currentFocus].classList.add('selected');
                }
            }

            function removeActive(suggestions) {
                for (let i = 0; i < suggestions.length; i++) {
                    suggestions[i].classList.remove('selected');
                }
            }
        }

        /**
         * Display autocomplete suggestions
         */
        function displaySuggestions(results, container, input, onSelect, isFratInput = false) {
            container.innerHTML = '';

            if (results.length === 0) {
                const itemType = isFratInput ? 'fraternities/sororities' : 'schools';
                container.innerHTML = `<div class="no-suggestions">No ${itemType} found. Try a different search.</div>`;
                container.classList.add('active');
                return;
            }

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                
                if (isFratInput) {
                    // Fraternity/Sorority format
                    div.innerHTML = `
                        <div class="suggestion-name">${item.name}</div>
                        <div class="suggestion-location">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div>
                    `;
                } else {
                    // School format
                    div.innerHTML = `
                        <div class="suggestion-name">${item.name}</div>
                        <div class="suggestion-location">${item.city}, ${item.state}</div>
                    `;
                }
                
                div.addEventListener('click', function() {
                    input.value = item.name;
                    input.classList.add('has-selection');
                    container.classList.remove('active');
                    container.innerHTML = '';
                    onSelect(item);
                });

                container.appendChild(div);
            });

            container.classList.add('active');
        }

        // Populate frat dropdown (unchanged)
        function populateDropdowns() {
            // Initialize autocomplete for both inputs after DOM is ready
            setTimeout(() => {
                const schoolInput = document.getElementById('school');
                const schoolSuggestions = document.getElementById('schoolSuggestions');
                const fratInput = document.getElementById('frat');
                const fratSuggestions = document.getElementById('fratSuggestions');
                
                if (schoolInput && schoolSuggestions) {
                    console.log('Initializing join form school autocomplete');
                    initializeAutocomplete('school', 'schoolSuggestions', (school) => {
                        selectedSchool = school;
                        console.log('School selected:', school);
                    });
                } else {
                    console.error('School autocomplete elements not found');
                }
                
                if (fratInput && fratSuggestions) {
                    console.log('Initializing join form frat autocomplete');
                    initializeAutocomplete('frat', 'fratSuggestions', (frat) => {
                        selectedFrat = frat;
                        console.log('Frat selected:', frat);
                    });
                } else {
                    console.error('Frat autocomplete elements not found');
                }
            }, 100);

            console.log('Initializing autocompletes');
        }

        // Load user data from Firestore
        async function loadUserData(uid) {
            try {
                const userRef = doc(db, 'users', uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    return userDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        /**
         * Load all users with rivalry data and their scores
         */
        async function loadAllRivalryUsers() {
            try {
                // Get all users with rivalry opt-in
                const usersQuery = query(
                    collection(db, 'users'),
                    where('rivalryOptIn', '==', true)
                );
                const usersSnapshot = await getDocs(usersQuery);
                
                const users = [];
                
                // For each user, get their best score
                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    
                    if (!userData.school || !userData.frat) continue;
                    
                    // Get user's best score from scores collection
                    const scoresQuery = query(
                        collection(db, 'scores'),
                        where('uid', '==', userData.uid)
                    );
                    const scoresSnapshot = await getDocs(scoresQuery);
                    
                    let bestScore = 0;
                    scoresSnapshot.forEach(scoreDoc => {
                        const scoreData = scoreDoc.data();
                        if (scoreData.score > bestScore) {
                            bestScore = scoreData.score;
                        }
                    });
                    
                    users.push({
                        uid: userData.uid,
                        name: userData.name || userData.email?.split('@')[0] || 'Anonymous',
                        school: userData.school,
                        frat: userData.frat,
                        score: bestScore
                    });
                }
                
                console.log('Loaded rivalry users:', users.length);
                return users;
            } catch (error) {
                console.error('Error loading rivalry users:', error);
                return [];
            }
        }

        /**
         * Display rivalry rankings for the current user
         */
        async function displayRivalryRankings(userId, school, frat) {
            console.log('Loading rivalry rankings for:', userId, school, frat);
            
            // Show loading state
            document.getElementById('individualRankDisplay').textContent = 'Loading...';
            document.getElementById('fratRankDisplay').textContent = 'Loading...';
            document.getElementById('topSeatDisplay').textContent = 'Loading...';
            
            // Load all rivalry users
            const allUsers = await loadAllRivalryUsers();
            
            if (allUsers.length === 0) {
                document.getElementById('individualRankDisplay').textContent = 'No rivalry data available yet.';
                document.getElementById('fratRankDisplay').textContent = 'No rivalry data available yet.';
                document.getElementById('topSeatDisplay').textContent = 'No rivalry data available yet.';
                return;
            }
            
            // 1. Individual Rank
            const individualRank = getIndividualRankForUser(userId, school, allUsers);
            const individualRankEl = document.getElementById('individualRankDisplay');
            
            if (individualRank.rank === null) {
                individualRankEl.innerHTML = `
                    <div style="color: #6b7280;">
                        Play a round to enter the rankings at <strong>${school}</strong>.
                    </div>
                `;
            } else {
                individualRankEl.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                        #${individualRank.rank} of ${individualRank.totalUsers}
                    </div>
                    <div style="color: #6b7280;">
                        Your rank at ${school}
                    </div>
                `;
            }
            
            // 2. Frat Rank
            const fratRank = getFratRankForUser(userId, allUsers);
            const fratRankEl = document.getElementById('fratRankDisplay');
            
            if (fratRank.rank === null) {
                fratRankEl.innerHTML = `
                    <div style="color: #6b7280;">
                        ${frat} has no scores yet at ${school}.
                    </div>
                `;
            } else {
                fratRankEl.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                        #${fratRank.rank} of ${fratRank.totalFrats}
                    </div>
                    <div style="color: #6b7280; margin-bottom: 8px;">
                        ${frat} rank at ${school}
                    </div>
                    <div style="color: #4b5563;">
                        Total frat score: <strong>${fratRank.totalScore.toLocaleString()}</strong>
                    </div>
                    <div style="color: #6b7280; font-size: 14px;">
                        ${fratRank.memberCount} member${fratRank.memberCount !== 1 ? 's' : ''} competing
                    </div>
                `;
            }
            
            // 3. TopSeat
            const topSeat = getTopSeatFratForSchool(school, allUsers);
            const topSeatEl = document.getElementById('topSeatDisplay');
            const topSeatSection = document.getElementById('topSeatSection');
            
            if (topSeat === null) {
                topSeatEl.innerHTML = `
                    <div style="color: #6b7280;">
                        No frats have scores yet at ${school}.
                    </div>
                `;
                topSeatSection.classList.remove('topseat-highlight');
            } else {
                const isUserFratTopSeat = topSeat.fratName === frat;
                
                if (isUserFratTopSeat) {
                    topSeatSection.classList.add('topseat-highlight');
                    topSeatEl.innerHTML = `
                        <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                            ${topSeat.fratName} <span class="topseat-badge">&#127942; TopSeat</span>
                        </div>
                        <div style="color: #4b5563; margin-bottom: 5px;">
                            Score: <strong>${topSeat.totalScore.toLocaleString()}</strong>
                        </div>
                        <div style="color: #16a34a; font-weight: bold; font-size: 16px;">
                            &#127881; Your frat holds the TopSeat at ${school}!
                        </div>
                    `;
                } else {
                    topSeatSection.classList.remove('topseat-highlight');
                    topSeatEl.innerHTML = `
                        <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                            ${topSeat.fratName}
                        </div>
                        <div style="color: #4b5563; margin-bottom: 5px;">
                            Score: <strong>${topSeat.totalScore.toLocaleString()}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 14px;">
                            Current TopSeat holder at ${school}
                        </div>
                    `;
                }
            }
        }

        // Determine which state to show
        async function showAppropriateState() {
            // Hide all states first
            notLoggedInState.classList.remove('active');
            notJoinedState.classList.remove('active');
            joinedState.classList.remove('active');

            // State 1: Not logged in
            if (!currentUser) {
                console.log('State: Not logged in');
                notLoggedInState.classList.add('active');
                return;
            }

            // State 2: Not joined (missing data or opt-in false)
            if (!userData || 
                !userData.rivalryOptIn || 
                !userData.school || 
                !userData.frat) {
                console.log('State: Not joined rivalries');
                populateDropdowns(); // Populate dropdowns when showing join form
                notJoinedState.classList.add('active');
                return;
            }

            // State 3: Joined
            console.log('State: Joined rivalries');
            document.getElementById('displaySchool').textContent = userData.school;
            document.getElementById('displayFrat').textContent = userData.frat;
            joinedState.classList.add('active');
            
            // Ensure we're in view mode (not edit mode) when loading state
            isEditMode = false;
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
            
            // Load and display rivalry rankings
            await displayRivalryRankings(currentUser.uid, userData.school, userData.frat);
        }

        // Go to login page
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };

        // =============================================================================
        // EDIT MODE FUNCTIONS
        // =============================================================================

        /**
         * Enter edit mode - show the edit form with current values
         */
        window.enterEditMode = function() {
            isEditMode = true;
            
            // Toggle visibility first
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
            
            // Populate edit dropdowns and autocomplete
            populateEditDropdowns();
            
            // Wait for autocomplete to initialize, then pre-fill
            setTimeout(() => {
                const editSchoolInput = document.getElementById('editSchool');
                const editFratInput = document.getElementById('editFrat');
                
                // Pre-fill school autocomplete with current value
                editSchoolInput.value = userData.school;
                editSchoolInput.classList.add('has-selection');
                
                // Set selected school object (find by name)
                if (window.SchoolsData && window.SchoolsData.getSchoolByName) {
                    selectedEditSchool = window.SchoolsData.getSchoolByName(userData.school);
                    if (!selectedEditSchool) {
                        // If not found in new list, create a placeholder
                        selectedEditSchool = { id: 'legacy', name: userData.school, city: '', state: '' };
                    }
                } else {
                    // Fallback if SchoolsData not loaded
                    selectedEditSchool = { id: 'legacy', name: userData.school, city: '', state: '' };
                }
                
                // Pre-fill frat autocomplete with current value
                editFratInput.value = userData.frat;
                editFratInput.classList.add('has-selection');
                
                // Set selected frat object (find by name)
                if (window.FratsData && window.FratsData.getFratByName) {
                    selectedEditFrat = window.FratsData.getFratByName(userData.frat);
                    if (!selectedEditFrat) {
                        // If not found in new list, create a placeholder
                        selectedEditFrat = { id: 'legacy', name: userData.frat, type: '' };
                    }
                } else {
                    // Fallback if FratsData not loaded
                    selectedEditFrat = { id: 'legacy', name: userData.frat, type: '' };
                }
            }, 200);
            
            // Clear any previous messages
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.className = 'message';
            editMessageArea.textContent = '';
        };

        /**
         * Cancel edit mode - return to view mode without saving
         */
        window.cancelEdit = function() {
            isEditMode = false;
            
            // Toggle visibility
            document.getElementById('editMode').style.display = 'none';
            document.getElementById('viewMode').style.display = 'block';
            
            // Clear any messages
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.className = 'message';
            editMessageArea.textContent = '';
        };

        /**
         * Populate the edit mode dropdowns
         */
        function populateEditDropdowns() {
            // Initialize autocomplete for both edit inputs after DOM is ready
            setTimeout(() => {
                const editSchoolInput = document.getElementById('editSchool');
                const editSchoolSuggestions = document.getElementById('editSchoolSuggestions');
                const editFratInput = document.getElementById('editFrat');
                const editFratSuggestions = document.getElementById('editFratSuggestions');
                
                if (editSchoolInput && editSchoolSuggestions) {
                    console.log('Initializing edit form school autocomplete');
                    initializeAutocomplete('editSchool', 'editSchoolSuggestions', (school) => {
                        selectedEditSchool = school;
                        console.log('Edit school selected:', school);
                    });
                } else {
                    console.error('Edit school autocomplete elements not found');
                }
                
                if (editFratInput && editFratSuggestions) {
                    console.log('Initializing edit form frat autocomplete');
                    initializeAutocomplete('editFrat', 'editFratSuggestions', (frat) => {
                        selectedEditFrat = frat;
                        console.log('Edit frat selected:', frat);
                    });
                } else {
                    console.error('Edit frat autocomplete elements not found');
                }
            }, 100);
        }

        /**
         * Show message in edit mode
         */
        function showEditMessage(text, type) {
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.textContent = text;
            editMessageArea.className = `message ${type}`;
            setTimeout(() => {
                editMessageArea.className = 'message';
                editMessageArea.textContent = '';
            }, 5000);
        }

        /**
         * Handle edit form submission
         */
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                showEditMessage('Please log in first', 'error');
                return;
            }

            // Validate school selection from autocomplete
            if (!selectedEditSchool || !selectedEditSchool.name) {
                showEditMessage('Please select a school from the list', 'error');
                document.getElementById('editSchool').classList.add('error');
                return;
            }

            // Validate frat selection from autocomplete
            if (!selectedEditFrat || !selectedEditFrat.name) {
                showEditMessage('Please select a fraternity/sorority from the list', 'error');
                document.getElementById('editFrat').classList.add('error');
                return;
            }

            const newSchool = selectedEditSchool.name; // Use the selected school's name
            const newFrat = selectedEditFrat.name; // Use the selected frat's name

            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            showLoading();

            try {
                // Update user data in Firestore
                const userRef = doc(db, 'users', currentUser.uid);
                await setDoc(userRef, {
                    school: newSchool,
                    frat: newFrat,
                    rivalryOptIn: true, // Keep them opted in
                    rivalryUpdatedAt: Timestamp.now()
                }, { merge: true });

                console.log('Successfully updated affiliation:', { newSchool, newFrat });

                // Reload user data
                userData = await loadUserData(currentUser.uid);

                // Exit edit mode
                isEditMode = false;
                document.getElementById('editMode').style.display = 'none';
                document.getElementById('viewMode').style.display = 'block';

                // Update display in view mode
                document.getElementById('displaySchool').textContent = newSchool;
                document.getElementById('displayFrat').textContent = newFrat;

                // Reload rankings with new school/frat
                await displayRivalryRankings(currentUser.uid, newSchool, newFrat);

                showEditMessage('Successfully updated!', 'success');

            } catch (error) {
                console.error('Error updating affiliation:', error);
                showEditMessage('Failed to save changes. Please try again.', 'error');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            } finally {
                hideLoading();
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        });

        // =============================================================================
        // JOIN RIVALRIES FORM HANDLER
        // =============================================================================

        // Go to login page
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };

        // Join rivalries - called when user submits the join form
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                showMessage('Please log in first', 'error');
                return;
            }

            // Validate school selection from autocomplete
            if (!selectedSchool || !selectedSchool.name) {
                showMessage('Please select a school from the list', 'error');
                document.getElementById('school').classList.add('error');
                return;
            }

            // Validate frat selection from autocomplete
            if (!selectedFrat || !selectedFrat.name) {
                showMessage('Please select a fraternity/sorority from the list', 'error');
                document.getElementById('frat').classList.add('error');
                return;
            }

            const school = selectedSchool.name; // Use the selected school's name
            const frat = selectedFrat.name; // Use the selected frat's name

            joinButton.disabled = true;
            joinButton.textContent = 'Joining...';
            showLoading();

            try {
                // Call the persistence function
                await persistRivalryJoin(currentUser.uid, school, frat);

                console.log('Successfully joined rivalries:', { school, frat });

                // Reload user data to get updated state
                userData = await loadUserData(currentUser.uid);

                // Show joined state
                showAppropriateState();
                showMessage('Successfully joined rivalries!', 'success');

            } catch (error) {
                console.error('Error joining rivalries:', error);
                showMessage('Failed to join rivalries. Please try again.', 'error');
                joinButton.disabled = false;
                joinButton.textContent = 'Join Rivalries';
            } finally {
                hideLoading();
                joinButton.disabled = false;
                joinButton.textContent = 'Join Rivalries';
            }
        });

        // =============================================================================
        // PERSISTENCE FUNCTION - Saves school, frat, and rivalryOptIn to Firestore
        // =============================================================================
        
        /**
         * Persist rivalry join data for a user
         * @param {string} uid - User ID
         * @param {string} school - Selected school
         * @param {string} frat - Selected fraternity/sorority
         */
        async function persistRivalryJoin(uid, school, frat) {
            const userRef = doc(db, 'users', uid);
            
            // Update user document with rivalry data
            // Using merge: true to preserve existing user fields
            await setDoc(userRef, {
                school: school,
                frat: frat,
                rivalryOptIn: true,
                rivalryJoinedAt: Timestamp.now()
            }, { merge: true });

            console.log('[persistRivalryJoin] Saved to Firestore:', { uid, school, frat, rivalryOptIn: true });
            
            // Log joined rivalries event
            try {
                const userContext = {
                    userId: uid,
                    email: currentUser?.email || null,
                    school: school,
                    frat: frat
                };
                await logJoinedRivalries(userContext);
            } catch (error) {
                console.error('Error logging rivalry join:', error);
            }
        }

        // =============================================================================

        // Leave rivalries
        window.leaveRivalries = async function() {
            if (!currentUser) return;

            if (!confirm('Are you sure you want to leave rivalries? You can rejoin anytime.')) {
                return;
            }

            showLoading();

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                
                // Set rivalryOptIn to false
                await setDoc(userRef, {
                    rivalryOptIn: false,
                    rivalryLeftAt: Timestamp.now()
                }, { merge: true });

                console.log('Left rivalries');

                // Reload user data
                userData = await loadUserData(currentUser.uid);

                // Show not joined state
                showAppropriateState();
                showMessage('You have left rivalries', 'success');

            } catch (error) {
                console.error('Error leaving rivalries:', error);
                alert('Failed to leave rivalries. Please try again.');
            } finally {
                hideLoading();
            }
        };

        // Initialize on auth state change
        onAuthStateChanged(auth, async (user) => {
            showLoading();

            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                
                // Load user data
                userData = await loadUserData(user.uid);
                console.log('User data:', userData);
            } else {
                console.log('No user authenticated');
                currentUser = null;
                userData = null;
            }

            showAppropriateState();
            hideLoading();
        });
    </script>
</body>
</html>
