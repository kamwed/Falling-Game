<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rivalries - Sky Fall</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #60a5fa, #2563eb);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tagline {
            font-size: 18px;
            opacity: 0.9;
        }

        .back-button {
            display: inline-block;
            padding: 12px 30px;
            background: #22c55e;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s;
            margin-bottom: 30px;
            border: none;
            cursor: pointer;
        }

        .back-button:hover {
            background: #16a34a;
            transform: scale(1.05);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: #1f2937;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subtitle {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* State containers */
        .state-container {
            display: none;
        }

        .state-container.active {
            display: block;
        }

        /* Not logged in state */
        .not-logged-in {
            text-align: center;
            padding: 60px 20px;
        }

        .not-logged-in h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .not-logged-in p {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        /* Not joined state */
        .not-joined {
            padding: 40px 20px;
        }

        .not-joined h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .not-joined p {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Join form */
        .join-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 16px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-hint {
            font-size: 14px;
            color: #6b7280;
            margin-top: 6px;
        }

        /* Joined state */
        .joined {
            padding: 40px 20px;
        }

        .joined h2 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .rivalry-info {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .rivalry-info .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .rivalry-info .affiliation {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 10px;
        }

        .rivalry-info .placeholder {
            font-size: 18px;
            color: #6b7280;
        }

        /* TopSeat highlighting */
        .topseat-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .topseat-highlight {
            background: linear-gradient(to right, #fef3c7, #fef3c7) !important;
            border: 2px solid #fbbf24 !important;
        }

        /* Buttons */
        .primary-button {
            width: 100%;
            padding: 14px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .primary-button:hover:not(:disabled) {
            background: #1e40af;
            transform: scale(1.02);
        }

        .primary-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .secondary-button {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .secondary-button:hover {
            background: #4b5563;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #86efac;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #fca5a5;
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 36px;
            }

            h1 {
                font-size: 28px;
            }

            .content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">&#127918; Sky Fall</div>
            <div class="tagline">Challenge your school and frat to rivalry battles!</div>
        </div>

        <a href="index.html" class="back-button">&larr; Back to Game</a>

        <div class="content">
            <h1>
                <span>&#9876;</span>
                Rivalries
            </h1>
            <p class="subtitle">Compete with other schools and fraternities!</p>

            <!-- State 1: Not Logged In -->
            <div id="notLoggedInState" class="state-container">
                <div class="not-logged-in">
                    <h2>Log in to participate in rivalries</h2>
                    <p>Join the competition and represent your school and fraternity!</p>
                    <button class="primary-button" onclick="goToLogin()">Log In</button>
                </div>
            </div>

            <!-- State 2: Not Joined -->
            <div id="notJoinedState" class="state-container">
                <div class="not-joined">
                    <h2>Join rivalries to represent your school and frat</h2>
                    <p>Select your school and fraternity to start competing in rivalries!</p>

                    <div id="messageArea" class="message"></div>

                    <form id="joinForm" class="join-form">
                        <div class="form-group">
                            <label for="school">School / University</label>
                            <select 
                                id="school" 
                                name="school" 
                                required
                            >
                                <option value="">-- Select your school --</option>
                            </select>
                            <div class="form-hint">Select your school or university</div>
                        </div>

                        <div class="form-group">
                            <label for="frat">Fraternity / Sorority</label>
                            <select 
                                id="frat" 
                                name="frat" 
                                required
                            >
                                <option value="">-- Select your fraternity/sorority --</option>
                            </select>
                            <div class="form-hint">Select your fraternity or sorority</div>
                        </div>

                        <button type="submit" class="primary-button" id="joinButton">Join Rivalries</button>
                    </form>
                </div>
            </div>

            <!-- State 3: Joined -->
            <div id="joinedState" class="state-container">
                <div class="joined">
                    <!-- View Mode -->
                    <div id="viewMode">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2 style="margin: 0;">Representing <span id="displayFrat"></span> at <span id="displaySchool"></span></h2>
                            <button 
                                onclick="enterEditMode()" 
                                style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;"
                                onmouseover="this.style.background='#4b5563'" 
                                onmouseout="this.style.background='#6b7280'"
                            >
                                Edit
                            </button>
                        </div>

                        <!-- Individual Rank Section -->
                        <div class="rivalry-info">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#128100; Your Individual Rank
                            </div>
                            <div id="individualRankDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <!-- Frat Rank Section -->
                        <div class="rivalry-info">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#9876; Your Frat's Rank
                            </div>
                            <div id="fratRankDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <!-- TopSeat Section -->
                        <div class="rivalry-info" id="topSeatSection">
                            <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 15px;">
                                &#127942; TopSeat
                            </div>
                            <div id="topSeatDisplay" style="font-size: 16px; color: #4b5563;">
                                Loading...
                            </div>
                        </div>

                        <button class="secondary-button" onclick="leaveRivalries()" style="display: block; margin: 20px auto 0;">
                            Leave Rivalries
                        </button>
                    </div>

                    <!-- Edit Mode -->
                    <div id="editMode" style="display: none;">
                        <h2 style="margin-bottom: 10px;">Edit Your Affiliation</h2>
                        <p style="color: #6b7280; margin-bottom: 30px;">Update your school and fraternity/sorority</p>

                        <div id="editMessageArea" class="message" style="margin-bottom: 20px;"></div>

                        <form id="editForm" class="join-form">
                            <div class="form-group">
                                <label for="editSchool">School / University</label>
                                <select 
                                    id="editSchool" 
                                    name="editSchool" 
                                    required
                                >
                                    <option value="">-- Select your school --</option>
                                </select>
                                <div class="form-hint">Select your school or university</div>
                            </div>

                            <div class="form-group">
                                <label for="editFrat">Fraternity / Sorority</label>
                                <select 
                                    id="editFrat" 
                                    name="editFrat" 
                                    required
                                >
                                    <option value="">-- Select your fraternity/sorority --</option>
                                </select>
                                <div class="form-hint">Select your fraternity or sorority</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="primary-button" id="saveButton" style="flex: 1;">
                                    Save Changes
                                </button>
                                <button type="button" class="secondary-button" onclick="cancelEdit()" style="flex: 1;">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <a href="index.html" class="back-button">Back to Game &#127918;</a>
            </div>
        </div>
    </div>

    <script type="module">
        // =============================================================================
        // RIVALRY STATS AGGREGATION FUNCTIONS
        // =============================================================================
        
        /**
         * Get individual rank for a user within their school
         */
        function getIndividualRankForUser(userId, schoolId, allUsers) {
            const schoolUsers = allUsers.filter(user => 
                user.school === schoolId && 
                user.score !== undefined && 
                user.score !== null
            );

            if (schoolUsers.length === 0) {
                return { rank: null, totalUsers: 0 };
            }

            const sortedUsers = schoolUsers.sort((a, b) => b.score - a.score);
            const userIndex = sortedUsers.findIndex(user => user.uid === userId);

            if (userIndex === -1) {
                return { rank: null, totalUsers: schoolUsers.length };
            }

            return {
                rank: userIndex + 1,
                totalUsers: schoolUsers.length
            };
        }

        /**
         * Get fraternity rank for a user's frat within their school
         */
        function getFratRankForUser(userId, allUsers) {
            const user = allUsers.find(u => u.uid === userId);

            if (!user || !user.school || !user.frat) {
                return { fratName: null, rank: null, totalFrats: 0, totalScore: 0, memberCount: 0 };
            }

            const schoolUsers = allUsers.filter(u => 
                u.school === user.school && 
                u.frat && 
                u.score !== undefined && 
                u.score !== null
            );

            if (schoolUsers.length === 0) {
                return { fratName: user.frat, rank: null, totalFrats: 0, totalScore: 0, memberCount: 0 };
            }

            const fratScores = {};
            
            schoolUsers.forEach(u => {
                if (!fratScores[u.frat]) {
                    fratScores[u.frat] = {
                        fratName: u.frat,
                        totalScore: 0,
                        memberCount: 0
                    };
                }
                fratScores[u.frat].totalScore += u.score;
                fratScores[u.frat].memberCount += 1;
            });

            const fratRankings = Object.values(fratScores).sort((a, b) => 
                b.totalScore - a.totalScore
            );

            const fratRank = fratRankings.findIndex(f => f.fratName === user.frat);

            if (fratRank === -1) {
                return { 
                    fratName: user.frat, 
                    rank: null, 
                    totalFrats: fratRankings.length, 
                    totalScore: 0,
                    memberCount: 0
                };
            }

            return {
                fratName: user.frat,
                rank: fratRank + 1,
                totalFrats: fratRankings.length,
                totalScore: fratRankings[fratRank].totalScore,
                memberCount: fratRankings[fratRank].memberCount
            };
        }

        /**
         * Get the top-ranked fraternity at a specific school (TopSeat)
         */
        function getTopSeatFratForSchool(schoolId, allUsers) {
            const schoolUsers = allUsers.filter(u => 
                u.school === schoolId && 
                u.frat && 
                u.score !== undefined && 
                u.score !== null
            );

            if (schoolUsers.length === 0) {
                return null;
            }

            const fratScores = {};
            
            schoolUsers.forEach(u => {
                if (!fratScores[u.frat]) {
                    fratScores[u.frat] = {
                        fratName: u.frat,
                        totalScore: 0,
                        memberCount: 0
                    };
                }
                fratScores[u.frat].totalScore += u.score;
                fratScores[u.frat].memberCount += 1;
            });

            const fratRankings = Object.values(fratScores).sort((a, b) => 
                b.totalScore - a.totalScore
            );

            return fratRankings.length > 0 ? fratRankings[0] : null;
        }

        // =============================================================================
        // FIREBASE AND APP INITIALIZATION
        // =============================================================================

        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, Timestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBic7ZeUQDgPZqORn0t6-wUCGHfEPASE10",
            authDomain: "topseat-d1d5d.firebaseapp.com",
            projectId: "topseat-d1d5d",
            storageBucket: "topseat-d1d5d.firebasestorage.app",
            messagingSenderId: "770306321288",
            appId: "1:770306321288:web:0e768acffc4d189672283d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =============================================================================
        // HARDCODED RIVALRY OPTIONS
        // Edit these arrays to add more schools and fraternities/sororities
        // =============================================================================
        
        const SCHOOLS = [
            "University of Michigan",
            "Michigan State University",
            "Ohio State University",
            "Penn State University",
            "University of Wisconsin",
            "Indiana University",
            "Purdue University",
            "University of Illinois",
            "Northwestern University",
            "University of Iowa",
            "University of Minnesota",
            "University of Nebraska",
            "Rutgers University",
            "University of Maryland"
        ];

        const FRATS = [
            "Alpha",
            "Beta",
            "Gamma",
            "Delta",
            "Sigma Chi",
            "Phi Delta Theta",
            "Kappa Sigma",
            "Lambda Chi Alpha",
            "Pi Kappa Alpha",
            "Sigma Alpha Epsilon",
            "Tau Kappa Epsilon",
            "Sigma Nu",
            "Phi Kappa Psi",
            "Delta Tau Delta",
            "Theta Chi",
            "Kappa Alpha",
            "Alpha Tau Omega",
            "Phi Gamma Delta",
            "Beta Theta Pi",
            "Sigma Phi Epsilon"
        ];

        // =============================================================================

        let currentUser = null;
        let userData = null;
        let isEditMode = false; // Track if user is editing their school/frat

        // DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notLoggedInState = document.getElementById('notLoggedInState');
        const notJoinedState = document.getElementById('notJoinedState');
        const joinedState = document.getElementById('joinedState');
        const messageArea = document.getElementById('messageArea');
        const joinForm = document.getElementById('joinForm');
        const joinButton = document.getElementById('joinButton');

        // Show/hide loading
        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // Show message
        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            setTimeout(() => {
                messageArea.className = 'message';
            }, 5000);
        }

        // Populate school and frat dropdowns
        function populateDropdowns() {
            const schoolSelect = document.getElementById('school');
            const fratSelect = document.getElementById('frat');

            // Clear existing options (except the placeholder)
            schoolSelect.innerHTML = '<option value="">-- Select your school --</option>';
            fratSelect.innerHTML = '<option value="">-- Select your fraternity/sorority --</option>';

            // Add school options
            SCHOOLS.forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                schoolSelect.appendChild(option);
            });

            // Add frat options
            FRATS.forEach(frat => {
                const option = document.createElement('option');
                option.value = frat;
                option.textContent = frat;
                fratSelect.appendChild(option);
            });

            console.log('Populated dropdowns:', { schools: SCHOOLS.length, frats: FRATS.length });
        }

        // Load user data from Firestore
        async function loadUserData(uid) {
            try {
                const userRef = doc(db, 'users', uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    return userDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        /**
         * Load all users with rivalry data and their scores
         */
        async function loadAllRivalryUsers() {
            try {
                // Get all users with rivalry opt-in
                const usersQuery = query(
                    collection(db, 'users'),
                    where('rivalryOptIn', '==', true)
                );
                const usersSnapshot = await getDocs(usersQuery);
                
                const users = [];
                
                // For each user, get their best score
                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    
                    if (!userData.school || !userData.frat) continue;
                    
                    // Get user's best score from scores collection
                    const scoresQuery = query(
                        collection(db, 'scores'),
                        where('uid', '==', userData.uid)
                    );
                    const scoresSnapshot = await getDocs(scoresQuery);
                    
                    let bestScore = 0;
                    scoresSnapshot.forEach(scoreDoc => {
                        const scoreData = scoreDoc.data();
                        if (scoreData.score > bestScore) {
                            bestScore = scoreData.score;
                        }
                    });
                    
                    users.push({
                        uid: userData.uid,
                        name: userData.name || userData.email?.split('@')[0] || 'Anonymous',
                        school: userData.school,
                        frat: userData.frat,
                        score: bestScore
                    });
                }
                
                console.log('Loaded rivalry users:', users.length);
                return users;
            } catch (error) {
                console.error('Error loading rivalry users:', error);
                return [];
            }
        }

        /**
         * Display rivalry rankings for the current user
         */
        async function displayRivalryRankings(userId, school, frat) {
            console.log('Loading rivalry rankings for:', userId, school, frat);
            
            // Show loading state
            document.getElementById('individualRankDisplay').textContent = 'Loading...';
            document.getElementById('fratRankDisplay').textContent = 'Loading...';
            document.getElementById('topSeatDisplay').textContent = 'Loading...';
            
            // Load all rivalry users
            const allUsers = await loadAllRivalryUsers();
            
            if (allUsers.length === 0) {
                document.getElementById('individualRankDisplay').textContent = 'No rivalry data available yet.';
                document.getElementById('fratRankDisplay').textContent = 'No rivalry data available yet.';
                document.getElementById('topSeatDisplay').textContent = 'No rivalry data available yet.';
                return;
            }
            
            // 1. Individual Rank
            const individualRank = getIndividualRankForUser(userId, school, allUsers);
            const individualRankEl = document.getElementById('individualRankDisplay');
            
            if (individualRank.rank === null) {
                individualRankEl.innerHTML = `
                    <div style="color: #6b7280;">
                        Play a round to enter the rankings at <strong>${school}</strong>.
                    </div>
                `;
            } else {
                individualRankEl.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                        #${individualRank.rank} of ${individualRank.totalUsers}
                    </div>
                    <div style="color: #6b7280;">
                        Your rank at ${school}
                    </div>
                `;
            }
            
            // 2. Frat Rank
            const fratRank = getFratRankForUser(userId, allUsers);
            const fratRankEl = document.getElementById('fratRankDisplay');
            
            if (fratRank.rank === null) {
                fratRankEl.innerHTML = `
                    <div style="color: #6b7280;">
                        ${frat} has no scores yet at ${school}.
                    </div>
                `;
            } else {
                fratRankEl.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                        #${fratRank.rank} of ${fratRank.totalFrats}
                    </div>
                    <div style="color: #6b7280; margin-bottom: 8px;">
                        ${frat} rank at ${school}
                    </div>
                    <div style="color: #4b5563;">
                        Total frat score: <strong>${fratRank.totalScore.toLocaleString()}</strong>
                    </div>
                    <div style="color: #6b7280; font-size: 14px;">
                        ${fratRank.memberCount} member${fratRank.memberCount !== 1 ? 's' : ''} competing
                    </div>
                `;
            }
            
            // 3. TopSeat
            const topSeat = getTopSeatFratForSchool(school, allUsers);
            const topSeatEl = document.getElementById('topSeatDisplay');
            const topSeatSection = document.getElementById('topSeatSection');
            
            if (topSeat === null) {
                topSeatEl.innerHTML = `
                    <div style="color: #6b7280;">
                        No frats have scores yet at ${school}.
                    </div>
                `;
                topSeatSection.classList.remove('topseat-highlight');
            } else {
                const isUserFratTopSeat = topSeat.fratName === frat;
                
                if (isUserFratTopSeat) {
                    topSeatSection.classList.add('topseat-highlight');
                    topSeatEl.innerHTML = `
                        <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                            ${topSeat.fratName} <span class="topseat-badge">&#127942; TopSeat</span>
                        </div>
                        <div style="color: #4b5563; margin-bottom: 5px;">
                            Score: <strong>${topSeat.totalScore.toLocaleString()}</strong>
                        </div>
                        <div style="color: #16a34a; font-weight: bold; font-size: 16px;">
                            &#127881; Your frat holds the TopSeat at ${school}!
                        </div>
                    `;
                } else {
                    topSeatSection.classList.remove('topseat-highlight');
                    topSeatEl.innerHTML = `
                        <div style="font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 5px;">
                            ${topSeat.fratName}
                        </div>
                        <div style="color: #4b5563; margin-bottom: 5px;">
                            Score: <strong>${topSeat.totalScore.toLocaleString()}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 14px;">
                            Current TopSeat holder at ${school}
                        </div>
                    `;
                }
            }
        }

        // Determine which state to show
        async function showAppropriateState() {
            // Hide all states first
            notLoggedInState.classList.remove('active');
            notJoinedState.classList.remove('active');
            joinedState.classList.remove('active');

            // State 1: Not logged in
            if (!currentUser) {
                console.log('State: Not logged in');
                notLoggedInState.classList.add('active');
                return;
            }

            // State 2: Not joined (missing data or opt-in false)
            if (!userData || 
                !userData.rivalryOptIn || 
                !userData.school || 
                !userData.frat) {
                console.log('State: Not joined rivalries');
                populateDropdowns(); // Populate dropdowns when showing join form
                notJoinedState.classList.add('active');
                return;
            }

            // State 3: Joined
            console.log('State: Joined rivalries');
            document.getElementById('displaySchool').textContent = userData.school;
            document.getElementById('displayFrat').textContent = userData.frat;
            joinedState.classList.add('active');
            
            // Ensure we're in view mode (not edit mode) when loading state
            isEditMode = false;
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
            
            // Load and display rivalry rankings
            await displayRivalryRankings(currentUser.uid, userData.school, userData.frat);
        }

        // Go to login page
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };

        // =============================================================================
        // EDIT MODE FUNCTIONS
        // =============================================================================

        /**
         * Enter edit mode - show the edit form with current values
         */
        window.enterEditMode = function() {
            isEditMode = true;
            
            // Populate edit dropdowns
            populateEditDropdowns();
            
            // Pre-fill with current values
            document.getElementById('editSchool').value = userData.school;
            document.getElementById('editFrat').value = userData.frat;
            
            // Toggle visibility
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
            
            // Clear any previous messages
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.className = 'message';
            editMessageArea.textContent = '';
        };

        /**
         * Cancel edit mode - return to view mode without saving
         */
        window.cancelEdit = function() {
            isEditMode = false;
            
            // Toggle visibility
            document.getElementById('editMode').style.display = 'none';
            document.getElementById('viewMode').style.display = 'block';
            
            // Clear any messages
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.className = 'message';
            editMessageArea.textContent = '';
        };

        /**
         * Populate the edit mode dropdowns
         */
        function populateEditDropdowns() {
            const editSchoolSelect = document.getElementById('editSchool');
            const editFratSelect = document.getElementById('editFrat');
            
            // Clear existing options (except the placeholder)
            editSchoolSelect.innerHTML = '<option value="">-- Select your school --</option>';
            editFratSelect.innerHTML = '<option value="">-- Select your fraternity/sorority --</option>';
            
            // Add school options
            SCHOOLS.forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                editSchoolSelect.appendChild(option);
            });
            
            // Add frat options
            FRATS.forEach(frat => {
                const option = document.createElement('option');
                option.value = frat;
                option.textContent = frat;
                editFratSelect.appendChild(option);
            });
        }

        /**
         * Show message in edit mode
         */
        function showEditMessage(text, type) {
            const editMessageArea = document.getElementById('editMessageArea');
            editMessageArea.textContent = text;
            editMessageArea.className = `message ${type}`;
            setTimeout(() => {
                editMessageArea.className = 'message';
                editMessageArea.textContent = '';
            }, 5000);
        }

        /**
         * Handle edit form submission
         */
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                showEditMessage('Please log in first', 'error');
                return;
            }

            const newSchool = document.getElementById('editSchool').value;
            const newFrat = document.getElementById('editFrat').value;

            // Validate both fields are selected
            if (!newSchool || newSchool === '') {
                showEditMessage('Please select a school', 'error');
                return;
            }

            if (!newFrat || newFrat === '') {
                showEditMessage('Please select a fraternity/sorority', 'error');
                return;
            }

            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            showLoading();

            try {
                // Update user data in Firestore
                const userRef = doc(db, 'users', currentUser.uid);
                await setDoc(userRef, {
                    school: newSchool,
                    frat: newFrat,
                    rivalryOptIn: true, // Keep them opted in
                    rivalryUpdatedAt: Timestamp.now()
                }, { merge: true });

                console.log('Successfully updated affiliation:', { newSchool, newFrat });

                // Reload user data
                userData = await loadUserData(currentUser.uid);

                // Exit edit mode
                isEditMode = false;
                document.getElementById('editMode').style.display = 'none';
                document.getElementById('viewMode').style.display = 'block';

                // Update display in view mode
                document.getElementById('displaySchool').textContent = newSchool;
                document.getElementById('displayFrat').textContent = newFrat;

                // Reload rankings with new school/frat
                await displayRivalryRankings(currentUser.uid, newSchool, newFrat);

                showEditMessage('Successfully updated!', 'success');

            } catch (error) {
                console.error('Error updating affiliation:', error);
                showEditMessage('Failed to save changes. Please try again.', 'error');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            } finally {
                hideLoading();
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        });

        // =============================================================================
        // JOIN RIVALRIES FORM HANDLER
        // =============================================================================

        // Go to login page
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };

        // Join rivalries - called when user submits the join form
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                showMessage('Please log in first', 'error');
                return;
            }

            const school = document.getElementById('school').value;
            const frat = document.getElementById('frat').value;

            // Validate both fields are selected
            if (!school || school === '') {
                showMessage('Please select a school', 'error');
                return;
            }

            if (!frat || frat === '') {
                showMessage('Please select a fraternity/sorority', 'error');
                return;
            }

            joinButton.disabled = true;
            joinButton.textContent = 'Joining...';
            showLoading();

            try {
                // Call the persistence function
                await persistRivalryJoin(currentUser.uid, school, frat);

                console.log('Successfully joined rivalries:', { school, frat });

                // Reload user data to get updated state
                userData = await loadUserData(currentUser.uid);

                // Show joined state
                showAppropriateState();
                showMessage('Successfully joined rivalries!', 'success');

            } catch (error) {
                console.error('Error joining rivalries:', error);
                showMessage('Failed to join rivalries. Please try again.', 'error');
                joinButton.disabled = false;
                joinButton.textContent = 'Join Rivalries';
            } finally {
                hideLoading();
                joinButton.disabled = false;
                joinButton.textContent = 'Join Rivalries';
            }
        });

        // =============================================================================
        // PERSISTENCE FUNCTION - Saves school, frat, and rivalryOptIn to Firestore
        // =============================================================================
        
        /**
         * Persist rivalry join data for a user
         * @param {string} uid - User ID
         * @param {string} school - Selected school
         * @param {string} frat - Selected fraternity/sorority
         */
        async function persistRivalryJoin(uid, school, frat) {
            const userRef = doc(db, 'users', uid);
            
            // Update user document with rivalry data
            // Using merge: true to preserve existing user fields
            await setDoc(userRef, {
                school: school,
                frat: frat,
                rivalryOptIn: true,
                rivalryJoinedAt: Timestamp.now()
            }, { merge: true });

            console.log('[persistRivalryJoin] Saved to Firestore:', { uid, school, frat, rivalryOptIn: true });
        }

        // =============================================================================

        // Leave rivalries
        window.leaveRivalries = async function() {
            if (!currentUser) return;

            if (!confirm('Are you sure you want to leave rivalries? You can rejoin anytime.')) {
                return;
            }

            showLoading();

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                
                // Set rivalryOptIn to false
                await setDoc(userRef, {
                    rivalryOptIn: false,
                    rivalryLeftAt: Timestamp.now()
                }, { merge: true });

                console.log('Left rivalries');

                // Reload user data
                userData = await loadUserData(currentUser.uid);

                // Show not joined state
                showAppropriateState();
                showMessage('You have left rivalries', 'success');

            } catch (error) {
                console.error('Error leaving rivalries:', error);
                alert('Failed to leave rivalries. Please try again.');
            } finally {
                hideLoading();
            }
        };

        // Initialize on auth state change
        onAuthStateChanged(auth, async (user) => {
            showLoading();

            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                
                // Load user data
                userData = await loadUserData(user.uid);
                console.log('User data:', userData);
            } else {
                console.log('No user authenticated');
                currentUser = null;
                userData = null;
            }

            showAppropriateState();
            hideLoading();
        });
    </script>
</body>
</html>
