<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireball Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loading-container {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            opacity: 0.9;
        }

        .admin-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .admin-container.show {
            display: block;
        }

        .admin-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .admin-title {
            font-size: 36px;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-icon {
            font-size: 40px;
        }

        .admin-subtitle {
            color: #6b7280;
            font-size: 16px;
        }

        .admin-user-info {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .admin-user-info strong {
            color: #374151;
        }

        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .placeholder-text {
            font-size: 24px;
            font-weight: 500;
        }

        .back-link {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .back-link:hover {
            background: #5568d3;
        }

        .error-container {
            display: none;
            text-align: center;
            color: white;
            max-width: 500px;
        }

        .error-container.show {
            display: block;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .error-message {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 25px;
        }

        .redirect-notice {
            font-size: 14px;
            opacity: 0.7;
        }

        .metric-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .metric-subtitle {
            font-size: 13px;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Verifying access...</div>
    </div>

    <!-- Admin Content (hidden until access verified) -->
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">
                <span class="admin-icon">&#128293;</span>
                Fireball Admin Analytics
            </h1>
            <p class="admin-subtitle">Administrative Dashboard - Authorized Access Only</p>
        </div>

        <div class="admin-user-info" id="userInfo">
            <strong>Logged in as:</strong> <span id="userEmail">Loading...</span>
        </div>

        <!-- Analytics Dashboard -->
        <div id="analyticsContent">
            <div id="loadingAnalytics" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                <div style="width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px;"></div>
                <div style="font-size: 18px; font-weight: 500;">Loading analytics...</div>
            </div>

            <div id="analyticsData" style="display: none;">
                <!-- Metrics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <!-- DAU Card -->
                    <div class="metric-card">
                        <div class="metric-label">Daily Active Users</div>
                        <div class="metric-value" id="dauValue">--</div>
                        <div class="metric-subtitle">Last 24 hours</div>
                    </div>

                    <!-- WAU Card -->
                    <div class="metric-card">
                        <div class="metric-label">Weekly Active Users</div>
                        <div class="metric-value" id="wauValue">--</div>
                        <div class="metric-subtitle">Last 7 days</div>
                    </div>

                    <!-- Total Attempts Card -->
                    <div class="metric-card">
                        <div class="metric-label">Total Attempts</div>
                        <div class="metric-value" id="totalAttemptsValue">--</div>
                        <div class="metric-subtitle">All time</div>
                    </div>

                    <!-- Recent Attempts Card -->
                    <div class="metric-card">
                        <div class="metric-label">Recent Attempts</div>
                        <div class="metric-value" id="recentAttemptsValue">--</div>
                        <div class="metric-subtitle">Last 7 days</div>
                    </div>
                </div>

                <!-- User Stats Section -->
                <div style="background: #f9fafb; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
                    <h2 style="font-size: 20px; color: #1f2937; margin-bottom: 20px; font-weight: 600;">User Statistics</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Total Users</div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;" id="totalUsersValue">--</div>
                        </div>
                        
                        <div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Users in Rivalries</div>
                            <div style="font-size: 32px; font-weight: bold; color: #10b981;" id="rivalryUsersValue">--</div>
                        </div>
                        
                        <div>
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Rivalry Adoption</div>
                            <div style="font-size: 32px; font-weight: bold; color: #f59e0b;" id="rivalryPercentValue">--%</div>
                        </div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div style="text-align: center; color: #9ca3af; font-size: 14px; margin-top: 20px;">
                    Last updated: <span id="lastUpdated">--</span>
                </div>

                <!-- Rivalry Rankings Section -->
                <div style="margin-top: 50px;">
                    <h2 style="font-size: 24px; color: #1f2937; margin-bottom: 30px; font-weight: 600; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                        üèÜ Rivalry Rankings (Last 7 Days)
                    </h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                        <!-- Top Schools -->
                        <div>
                            <h3 style="font-size: 18px; color: #374151; margin-bottom: 15px; font-weight: 600;">
                                üéì Top Schools by Attempts
                            </h3>
                            <div id="topSchoolsTable" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <!-- Table content will be inserted here -->
                            </div>
                        </div>

                        <!-- Top Frats -->
                        <div>
                            <h3 style="font-size: 18px; color: #374151; margin-bottom: 15px; font-weight: 600;">
                                üèõÔ∏è Top Frats by Attempts
                            </h3>
                            <div id="topFratsTable" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <!-- Table content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="analyticsError" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <div style="font-size: 20px; color: #ef4444; font-weight: 600; margin-bottom: 10px;">Failed to Load Analytics</div>
                <div style="color: #6b7280;" id="errorDetails">An error occurred while loading the analytics data.</div>
            </div>
        </div>

        <div style="text-align: center;">
            <a href="index.html" class="back-link">Return to Game</a>
        </div>
    </div>

    <!-- Error/Access Denied -->
    <div id="errorContainer" class="error-container">
        <div class="error-icon">&#128274;</div>
        <div class="error-title">Access Denied</div>
        <div class="error-message" id="errorMessage">You do not have permission to access this page.</div>
        <div class="redirect-notice">Redirecting to main page...</div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBic7ZeUQDgPZqORn0t6-wUCGHfEPASE10",
            authDomain: "topseat-d1d5d.firebaseapp.com",
            projectId: "topseat-d1d5d",
            storageBucket: "topseat-d1d5d.firebasestorage.app",
            messagingSenderId: "770306321288",
            appId: "1:770306321288:web:0e768acffc4d189672283d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM elements
        const loadingContainer = document.getElementById('loadingContainer');
        const adminContainer = document.getElementById('adminContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const userEmail = document.getElementById('userEmail');

        // =============================================================================
        // ANALYTICS QUERY FUNCTIONS
        // =============================================================================

        /**
         * Get Daily Active Users (DAU)
         * Count unique userIds with game_started or score_submitted events in last 24 hours
         */
        async function getDailyActiveUsers() {
            try {
                const oneDayAgo = new Date();
                oneDayAgo.setHours(oneDayAgo.getHours() - 24);
                
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', 'in', ['game_started', 'score_submitted']),
                    where('timestamp', '>=', Timestamp.fromDate(oneDayAgo))
                );
                
                const snapshot = await getDocs(q);
                
                // Count unique userIds
                const uniqueUsers = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId && data.userId !== 'anonymous') {
                        uniqueUsers.add(data.userId);
                    }
                });
                
                console.log('üìä DAU:', uniqueUsers.size);
                return uniqueUsers.size;
            } catch (error) {
                console.error('Error fetching DAU:', error);
                return 0;
            }
        }

        /**
         * Get Weekly Active Users (WAU)
         * Count unique userIds with game_started or score_submitted events in last 7 days
         */
        async function getWeeklyActiveUsers() {
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', 'in', ['game_started', 'score_submitted']),
                    where('timestamp', '>=', Timestamp.fromDate(sevenDaysAgo))
                );
                
                const snapshot = await getDocs(q);
                
                // Count unique userIds
                const uniqueUsers = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId && data.userId !== 'anonymous') {
                        uniqueUsers.add(data.userId);
                    }
                });
                
                console.log('üìä WAU:', uniqueUsers.size);
                return uniqueUsers.size;
            } catch (error) {
                console.error('Error fetching WAU:', error);
                return 0;
            }
        }

        /**
         * Get Total Attempts (all time)
         * Count all game_started events
         */
        async function getTotalAttempts() {
            try {
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', '==', 'game_started')
                );
                
                const snapshot = await getDocs(q);
                
                console.log('üìä Total Attempts:', snapshot.size);
                return snapshot.size;
            } catch (error) {
                console.error('Error fetching total attempts:', error);
                return 0;
            }
        }

        /**
         * Get Recent Attempts (last 7 days)
         * Count game_started events in last 7 days
         */
        async function getRecentAttempts() {
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', '==', 'game_started'),
                    where('timestamp', '>=', Timestamp.fromDate(sevenDaysAgo))
                );
                
                const snapshot = await getDocs(q);
                
                console.log('üìä Recent Attempts (7d):', snapshot.size);
                return snapshot.size;
            } catch (error) {
                console.error('Error fetching recent attempts:', error);
                return 0;
            }
        }

        /**
         * Get User Statistics
         * Returns total users, rivalry users, and percentage
         */
        async function getUserStatistics() {
            try {
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                
                const totalUsers = snapshot.size;
                let rivalryUsers = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Count users with both school AND frat set
                    if (data.school && data.frat) {
                        rivalryUsers++;
                    }
                });
                
                const percentage = totalUsers > 0 ? ((rivalryUsers / totalUsers) * 100).toFixed(1) : 0;
                
                console.log('üìä User Stats:', { totalUsers, rivalryUsers, percentage });
                return { totalUsers, rivalryUsers, percentage };
            } catch (error) {
                console.error('Error fetching user stats:', error);
                return { totalUsers: 0, rivalryUsers: 0, percentage: 0 };
            }
        }

        /**
         * Get Top Schools by Attempts (Last 7 Days)
         * Groups game_started events by school and counts attempts
         * Returns top 5 schools sorted by attempt count
         */
        async function getTopSchoolsByAttempts() {
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', '==', 'game_started'),
                    where('timestamp', '>=', Timestamp.fromDate(sevenDaysAgo))
                );
                
                const snapshot = await getDocs(q);
                
                // Count attempts per school
                const schoolCounts = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const school = data.school;
                    
                    // Only count if school is set (not null/undefined/empty)
                    if (school && school.trim() !== '') {
                        if (!schoolCounts[school]) {
                            schoolCounts[school] = 0;
                        }
                        schoolCounts[school]++;
                    }
                });
                
                // Convert to array and sort by count descending
                const sortedSchools = Object.entries(schoolCounts)
                    .map(([school, count]) => ({ school, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); // Top 5
                
                console.log('üìä Top Schools:', sortedSchools);
                return sortedSchools;
            } catch (error) {
                console.error('Error fetching top schools:', error);
                return [];
            }
        }

        /**
         * Get Top Frats by Attempts (Last 7 Days)
         * Groups game_started events by frat and counts attempts
         * Returns top 5 frats sorted by attempt count
         */
        async function getTopFratsByAttempts() {
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const eventsRef = collection(db, 'events');
                const q = query(
                    eventsRef,
                    where('eventType', '==', 'game_started'),
                    where('timestamp', '>=', Timestamp.fromDate(sevenDaysAgo))
                );
                
                const snapshot = await getDocs(q);
                
                // Count attempts per frat, also track schools
                const fratData = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const frat = data.frat;
                    const school = data.school;
                    
                    // Only count if frat is set (not null/undefined/empty)
                    if (frat && frat.trim() !== '') {
                        if (!fratData[frat]) {
                            fratData[frat] = {
                                count: 0,
                                schools: new Set()
                            };
                        }
                        fratData[frat].count++;
                        
                        // Track which schools this frat appears in
                        if (school && school.trim() !== '') {
                            fratData[frat].schools.add(school);
                        }
                    }
                });
                
                // Convert to array and sort by count descending
                const sortedFrats = Object.entries(fratData)
                    .map(([frat, data]) => ({
                        frat,
                        count: data.count,
                        schools: Array.from(data.schools)
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); // Top 5
                
                console.log('üìä Top Frats:', sortedFrats);
                return sortedFrats;
            } catch (error) {
                console.error('Error fetching top frats:', error);
                return [];
            }
        }

        /**
         * Render Top Schools table
         */
        function renderTopSchoolsTable(schools) {
            const tableContainer = document.getElementById('topSchoolsTable');
            
            if (!schools || schools.length === 0) {
                tableContainer.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìö</div>
                        <div style="font-size: 16px;">No rivalry data yet</div>
                        <div style="font-size: 14px; margin-top: 5px;">Schools will appear here once users join rivalries and play games</div>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Rank</th>
                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">School</th>
                            <th style="padding: 12px 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Attempts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            schools.forEach((school, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 12px 16px; font-size: 18px;">${medal} ${rank}</td>
                        <td style="padding: 12px 16px; font-weight: 500; color: #1f2937;">${school.school}</td>
                        <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: #667eea;">${school.count.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        /**
         * Render Top Frats table
         */
        function renderTopFratsTable(frats) {
            const tableContainer = document.getElementById('topFratsTable');
            
            if (!frats || frats.length === 0) {
                tableContainer.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üèõÔ∏è</div>
                        <div style="font-size: 16px;">No rivalry data yet</div>
                        <div style="font-size: 14px; margin-top: 5px;">Frats will appear here once users join rivalries and play games</div>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Rank</th>
                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Frat/Sorority</th>
                            <th style="padding: 12px 16px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Attempts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            frats.forEach((frat, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                
                // Show school(s) if available
                let fratDisplay = frat.frat;
                if (frat.schools && frat.schools.length > 0) {
                    const schoolList = frat.schools.slice(0, 2).join(', ');
                    const moreSchools = frat.schools.length > 2 ? ` +${frat.schools.length - 2}` : '';
                    fratDisplay += `<div style="font-size: 12px; color: #9ca3af; font-weight: normal; margin-top: 2px;">${schoolList}${moreSchools}</div>`;
                }
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 12px 16px; font-size: 18px;">${medal} ${rank}</td>
                        <td style="padding: 12px 16px; font-weight: 500; color: #1f2937;">${fratDisplay}</td>
                        <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: #667eea;">${frat.count.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        /**
         * Load all analytics data and update UI
         */
        async function loadAnalytics() {
            try {
                console.log('üìä Loading analytics data...');
                
                // Show loading state
                document.getElementById('loadingAnalytics').style.display = 'block';
                document.getElementById('analyticsData').style.display = 'none';
                document.getElementById('analyticsError').style.display = 'none';
                
                // Fetch all metrics in parallel
                const [dau, wau, totalAttempts, recentAttempts, userStats, topSchools, topFrats] = await Promise.all([
                    getDailyActiveUsers(),
                    getWeeklyActiveUsers(),
                    getTotalAttempts(),
                    getRecentAttempts(),
                    getUserStatistics(),
                    getTopSchoolsByAttempts(),
                    getTopFratsByAttempts()
                ]);
                
                // Update UI with data
                document.getElementById('dauValue').textContent = dau.toLocaleString();
                document.getElementById('wauValue').textContent = wau.toLocaleString();
                document.getElementById('totalAttemptsValue').textContent = totalAttempts.toLocaleString();
                document.getElementById('recentAttemptsValue').textContent = recentAttempts.toLocaleString();
                document.getElementById('totalUsersValue').textContent = userStats.totalUsers.toLocaleString();
                document.getElementById('rivalryUsersValue').textContent = userStats.rivalryUsers.toLocaleString();
                document.getElementById('rivalryPercentValue').textContent = `${userStats.percentage}%`;
                
                // Render rivalry rankings tables
                renderTopSchoolsTable(topSchools);
                renderTopFratsTable(topFrats);
                
                // Set last updated time
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleString();
                
                // Hide loading, show data
                document.getElementById('loadingAnalytics').style.display = 'none';
                document.getElementById('analyticsData').style.display = 'block';
                
                console.log('‚úÖ Analytics loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading analytics:', error);
                
                // Show error state
                document.getElementById('loadingAnalytics').style.display = 'none';
                document.getElementById('analyticsError').style.display = 'block';
                document.getElementById('errorDetails').textContent = error.message || 'An error occurred while loading the analytics data.';
            }
        }

        // =============================================================================
        // ADMIN ACCESS VERIFICATION
        // =============================================================================

        /**
         * Check if the current user has admin access
         * @param {Object} user - Firebase user object
         * @returns {Promise<boolean>} True if user is admin
         */
        async function checkAdminAccess(user) {
            if (!user) {
                console.log('‚ùå No user authenticated');
                return false;
            }

            try {
                console.log('üîç Checking admin status for:', user.uid);
                
                // Fetch user document from Firestore
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);

                if (!userDoc.exists()) {
                    console.log('‚ùå User document not found in Firestore');
                    return false;
                }

                const userData = userDoc.data();
                const isAdmin = userData.isAdmin === true;

                console.log('üìã User data:', {
                    uid: user.uid,
                    email: user.email,
                    isAdmin: isAdmin
                });

                return isAdmin;
            } catch (error) {
                console.error('‚ùå Error checking admin access:', error);
                return false;
            }
        }

        /**
         * Show access denied and redirect to main page
         * @param {string} reason - Reason for denial
         */
        function denyAccess(reason) {
            console.log('üö´ Access denied:', reason);
            
            loadingContainer.style.display = 'none';
            adminContainer.classList.remove('show');
            errorContainer.classList.add('show');
            errorMessage.textContent = reason;

            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }

        /**
         * Grant access and show admin panel
         * @param {Object} user - Firebase user object
         */
        async function grantAccess(user) {
            console.log('‚úÖ Access granted to:', user.email);
            
            loadingContainer.style.display = 'none';
            adminContainer.classList.add('show');
            userEmail.textContent = user.email;
            
            // Load analytics data
            await loadAnalytics();
        }

        /**
         * Main access control flow
         */
        async function verifyAndLoadAdmin() {
            console.log('üîê Starting admin access verification...');

            // Wait for auth state
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    // Not logged in - redirect immediately
                    console.log('‚ö†Ô∏è User not authenticated');
                    denyAccess('You must be logged in to access this page.');
                    return;
                }

                // User is logged in - check admin status
                console.log('üë§ User authenticated:', user.email);
                
                try {
                    const isAdmin = await checkAdminAccess(user);

                    if (isAdmin) {
                        // User is admin - grant access
                        grantAccess(user);
                    } else {
                        // User is not admin - deny access
                        denyAccess('You do not have administrator privileges.');
                    }
                } catch (error) {
                    console.error('‚ùå Error during verification:', error);
                    denyAccess('An error occurred while verifying your access.');
                }
            });
        }

        // Start verification when page loads
        verifyAndLoadAdmin();
    </script>
</body>
</html>
